---
title: Git Usage
review:
    comment: ''
    date: ''
    status: ok
labels:
    - git
toc: true
confluence:
    ajs-parent-page-id: '3868947'
    ajs-parent-page-title: Development Tools and Process
    ajs-space-key: CORG
    ajs-space-name: Core Developer Guide
    canonical: Git+Usage
    canonical_source: 'https://doc.nuxeo.com/display/CORG/Git+Usage'
    page_id: '6422534'
    shortlink: BgBi
    shortlink_source: 'https://doc.nuxeo.com/x/BgBi'
    source_link: /display/CORG/Git+Usage
tree_item_index: 300
history:
    -
        author: Solen Guitter
        date: '2016-09-02 07:41'
        message: ''
        version: '100'
    -
        author: Julien Carsique
        date: '2016-07-28 13:31'
        message: Git LFS
        version: '99'
    -
        author: Julien Carsique
        date: '2016-06-24 15:22'
        message: ''
        version: '98'
    -
        author: Julien Carsique
        date: '2016-06-24 15:14'
        message: fetch pull requests
        version: '97'
    -
        author: Julien Carsique
        date: '2016-06-24 15:07'
        message: fetch pull requests
        version: '96'
    -
        author: Julien Carsique
        date: '2016-03-21 11:18'
        message: ''
        version: '95'
    -
        author: Julien Carsique
        date: '2016-03-21 11:18'
        message: pull request merge instructions
        version: '94'
    -
        author: Julien Carsique
        date: '2016-02-15 09:59'
        message: curl -L because of redirect to patch-diff.githubusercontent.com
        version: '93'
    -
        author: Julien Carsique
        date: '2015-11-25 11:27'
        message: ''
        version: '92'
    -
        author: Julien Carsique
        date: '2015-11-25 11:07'
        message: ''
        version: '91'
    -
        author: Thomas Roger
        date: '2015-11-24 13:46'
        message: ''
        version: '90'
    -
        author: Julien Carsique
        date: '2015-11-23 13:43'
        message: >-
            prepare_repo.sh is required until
            https://github.com/robinst/git-merge-repos/issues/3
        version: '89'
    -
        author: Julien Carsique
        date: '2015-10-30 16:16'
        message: ''
        version: '88'
    -
        author: Julien Carsique
        date: '2015-10-15 13:16'
        message: git-up
        version: '87'
    -
        author: Arnaud Kervern
        date: '2015-10-09 09:03'
        message: ''
        version: '86'
    -
        author: Solen Guitter
        date: '2015-09-25 16:19'
        message: Fix page layout to use 2/3 layout
        version: '85'
    -
        author: Julien Carsique
        date: '2015-02-26 15:40'
        message: ''
        version: '84'
    -
        author: Julien Carsique
        date: '2015-02-26 15:39'
        message: Normalize end of lines
        version: '83'
    -
        author: Julien Carsique
        date: '2015-02-12 17:13'
        message: NXDOC-535
        version: '82'
    -
        author: Julien Carsique
        date: '2015-01-30 14:49'
        message: ''
        version: '81'
    -
        author: Manon Lumeau
        date: '2014-10-27 10:04'
        message: ''
        version: '80'
    -
        author: Thomas Roger
        date: '2014-10-23 19:30'
        message: ''
        version: '79'
    -
        author: Julien Carsique
        date: '2014-10-13 16:12'
        message: ''
        version: '78'
    -
        author: Julien Carsique
        date: '2014-10-08 14:40'
        message: ''
        version: '77'
    -
        author: Julien Carsique
        date: '2014-10-08 14:36'
        message: ''
        version: '76'
    -
        author: Solen Guitter
        date: '2014-10-08 14:21'
        message: ''
        version: '75'
    -
        author: Solen Guitter
        date: '2014-10-08 14:20'
        message: >-
            Move section Use Case Moving an Add-on into a Nuxeo-Features out of
            warning
        version: '74'
    -
        author: Benoit Delbosc
        date: '2014-10-08 14:06'
        message: ''
        version: '73'
    -
        author: Julien Carsique
        date: '2014-09-15 17:03'
        message: ''
        version: '72'
    -
        author: Julien Carsique
        date: '2014-09-15 16:58'
        message: NXP-14878 - extract repository
        version: '71'
    -
        author: Julien Carsique
        date: '2014-09-15 16:10'
        message: NXP-14878 - merge repositories
        version: '70'
    -
        author: Julien Carsique
        date: '2014-07-29 17:39'
        message: ''
        version: '69'
    -
        author: Julien Carsique
        date: '2014-07-29 17:37'
        message: ''
        version: '68'
    -
        author: Solen Guitter
        date: '2014-07-02 14:55'
        message: ''
        version: '67'
    -
        author: Solen Guitter
        date: '2014-07-02 14:54'
        message: ''
        version: '66'
    -
        author: Manon Lumeau
        date: '2014-06-17 10:32'
        message: ''
        version: '65'
    -
        author: Julien Carsique
        date: '2014-06-16 18:25'
        message: ''
        version: '64'
    -
        author: Julien Carsique
        date: '2014-06-16 18:25'
        message: ''
        version: '63'
    -
        author: Julien Carsique
        date: '2013-07-30 12:57'
        message: ''
        version: '62'
    -
        author: Solen Guitter
        date: '2013-06-28 16:37'
        message: ''
        version: '61'
    -
        author: Solen Guitter
        date: '2013-06-28 16:36'
        message: Fixed typos
        version: '60'
    -
        author: Julien Carsique
        date: '2013-06-20 10:44'
        message: ''
        version: '59'
    -
        author: Julien Carsique
        date: '2013-06-20 10:11'
        message: ''
        version: '58'
    -
        author: Julien Carsique
        date: '2013-04-30 12:07'
        message: ''
        version: '57'
    -
        author: Julien Carsique
        date: '2013-04-23 15:13'
        message: ''
        version: '56'
    -
        author: Julien Carsique
        date: '2013-04-23 15:06'
        message: ''
        version: '55'
    -
        author: Anahide Tchertchian
        date: '2013-02-21 17:24'
        message: add help to remove remote branch
        version: '54'
    -
        author: Julien Carsique
        date: '2013-01-28 16:41'
        message: GitHub pull-request tip
        version: '53'
    -
        author: Solen Guitter
        date: '2012-12-03 17:06'
        message: ''
        version: '52'
    -
        author: Antoine Taillefer
        date: '2012-05-11 11:08'
        message: Migrated to Confluence 4.0
        version: '51'
    -
        author: Antoine Taillefer
        date: '2012-05-11 11:08'
        message: ''
        version: '50'
    -
        author: Anahide Tchertchian
        date: '2012-04-13 18:25'
        message: ''
        version: '49'
    -
        author: Julien Carsique
        date: '2012-04-13 17:41'
        message: ''
        version: '48'
    -
        author: Anahide Tchertchian
        date: '2012-04-13 17:31'
        message: ''
        version: '47'
    -
        author: Antoine Taillefer
        date: '2012-04-10 14:55'
        message: ''
        version: '46'
    -
        author: Julien Carsique
        date: '2012-02-02 15:59'
        message: ''
        version: '45'
    -
        author: Julien Carsique
        date: '2012-02-02 15:57'
        message: ''
        version: '44'
    -
        author: Anahide Tchertchian
        date: '2012-02-02 14:59'
        message: ''
        version: '43'
    -
        author: Solen Guitter
        date: '2012-01-31 10:46'
        message: ''
        version: '42'
    -
        author: Anahide Tchertchian
        date: '2012-01-30 18:38'
        message: ''
        version: '41'
    -
        author: Anahide Tchertchian
        date: '2012-01-30 18:14'
        message: ''
        version: '40'
    -
        author: Anahide Tchertchian
        date: '2012-01-30 18:05'
        message: ''
        version: '39'
    -
        author: Anahide Tchertchian
        date: '2012-01-30 17:58'
        message: ''
        version: '38'
    -
        author: Anahide Tchertchian
        date: '2012-01-30 17:58'
        message: ''
        version: '37'
    -
        author: Anahide Tchertchian
        date: '2012-01-30 17:55'
        message: ''
        version: '36'
    -
        author: Anahide Tchertchian
        date: '2012-01-30 17:41'
        message: ''
        version: '35'
    -
        author: Julien Carsique
        date: '2012-01-16 15:10'
        message: ''
        version: '34'
    -
        author: Julien Carsique
        date: '2012-01-16 15:08'
        message: ''
        version: '33'
    -
        author: Julien Carsique
        date: '2012-01-16 15:06'
        message: ''
        version: '32'
    -
        author: Julien Carsique
        date: '2012-01-11 19:19'
        message: ''
        version: '31'
    -
        author: Julien Carsique
        date: '2012-01-11 19:16'
        message: ''
        version: '30'
    -
        author: Julien Carsique
        date: '2012-01-11 19:09'
        message: ''
        version: '29'
    -
        author: Julien Carsique
        date: '2012-01-11 19:02'
        message: Updated Git aliases
        version: '28'
    -
        author: Benoit Delbosc
        date: '2012-01-09 17:22'
        message: ''
        version: '27'
    -
        author: Julien Carsique
        date: '2012-01-05 18:59'
        message: add pullr alias
        version: '26'
    -
        author: Julien Carsique
        date: '2012-01-05 17:02'
        message: ''
        version: '25'
    -
        author: Julien Carsique
        date: '2012-01-05 17:02'
        message: ''
        version: '24'
    -
        author: Julien Carsique
        date: '2012-01-05 16:35'
        message: ''
        version: '23'
    -
        author: Julien Carsique
        date: '2012-01-05 16:33'
        message: ''
        version: '22'
    -
        author: Julien Carsique
        date: '2012-01-04 15:50'
        message: ''
        version: '21'
    -
        author: Anahide Tchertchian
        date: '2012-01-04 15:42'
        message: ''
        version: '20'
    -
        author: Anahide Tchertchian
        date: '2012-01-04 15:40'
        message: ''
        version: '19'
    -
        author: Anahide Tchertchian
        date: '2012-01-04 14:41'
        message: ''
        version: '18'
    -
        author: Anahide Tchertchian
        date: '2012-01-04 14:40'
        message: ''
        version: '17'
    -
        author: Olivier Grisel
        date: '2012-01-03 14:59'
        message: ''
        version: '16'
    -
        author: Olivier Grisel
        date: '2012-01-03 14:58'
        message: ''
        version: '15'
    -
        author: Olivier Grisel
        date: '2012-01-03 14:56'
        message: ''
        version: '14'
    -
        author: Olivier Grisel
        date: '2012-01-03 14:06'
        message: git commit --ament
        version: '13'
    -
        author: Olivier Grisel
        date: '2011-12-29 16:29'
        message: ''
        version: '12'
    -
        author: Julien Carsique
        date: '2011-12-21 14:44'
        message: ''
        version: '11'
    -
        author: Julien Carsique
        date: '2011-12-21 14:44'
        message: git cherry-pick
        version: '10'
    -
        author: Julien Carsique
        date: '2011-12-21 12:28'
        message: ''
        version: '9'
    -
        author: Julien Carsique
        date: '2011-12-21 12:16'
        message: git equivalent for hg cat
        version: '8'
    -
        author: Julien Carsique
        date: '2011-12-19 11:11'
        message: add sample commands
        version: '7'
    -
        author: Julien Carsique
        date: '2011-12-15 12:46'
        message: ''
        version: '6'
    -
        author: Thomas Roger
        date: '2011-11-30 23:01'
        message: ''
        version: '5'
    -
        author: Thomas Roger
        date: '2011-11-30 21:48'
        message: ''
        version: '4'
    -
        author: Thomas Roger
        date: '2011-08-16 14:59'
        message: ''
        version: '3'
    -
        author: Julien Carsique
        date: '2011-04-08 18:46'
        message: ''
        version: '2'
    -
        author: Julien Carsique
        date: '2011-04-08 18:39'
        message: ''
        version: '1'

---
Prerequisites: having Git installed. For installation and configuration instruction, please refer to [Installing Git]({{page page='installing-git'}}).

## Overview and Online Documentation

[http://rogerdudler.github.com/git-guide/](http://rogerdudler.github.com/git-guide/): The simple guide

[http://git-scm.com/documentation](http://git-scm.com/documentation): Very complete documentation (reference, cheat sheets, books).

[http://gitready.com/](http://gitready.com/)

[https://git.wiki.kernel.org/index.php/InterfacesFrontendsAndTools](https://git.wiki.kernel.org/index.php/InterfacesFrontendsAndTools): Interfaces, frontends and tools listing.

## Git Commands

### Most Useful Commands

To **clone a repository**, do:

```
git clone git://github.com/nuxeo/nuxeo.git

```

To **retrieve remote changes**, do:

```
git fetch

```

To **update your repository according to remote changes**, do:

```
git pull --rebase

```

This is equivalent to:

```
git fetch && git rebase

```

To **view the current status** of your repository, do:

```
git status

```

To **commit local changes** to a file, do:

```
git commit -m "NXP-xxxx: my commit message" myfile.txt

```

or, to **commit all modified files** at once:

```
git commit -m "NXP-xxxx: my commit message" -a

```

To **push** those changes remotely, do:

```
git push

```

To **view the changeset** of a given commit, do:

```
git show <commit_identifier>

```

To **apply a given changeset** to another branch, do:

```
git cherry-pick <commit_identifier>

```

To **edit the last commit**:

```
git commit --amend [...]
```

Suppose you made a mistake and made a commit with a bad content, and you forgot to reference the JIRA issue in the message:

```
echo "my awesome content, i hope i did not make any missstake" > some_file.txt
git commit -m "adding my awesome information" some_file.txt

```

To fix it just edit the file to replace the faulty line:

```
echo "my awesome content, i hope i did not make any mistake" > some_file.txt

```

Then redo the commit with the right commit message:

```
git commit --amend -m "NXP-xxxx: adding my awesome information" some_file.txt
```

To **undo the last commit** (without having pushed anything to public repo), do:

```
# Cancel last commit but keep changes to be commited
git reset --soft HEAD~

# Cancel last commit and keep changes but not marked for commit
git reset --mixed HEAD~

# Cancel last commit and discard changes
git reset --hard HEAD~
```

To **merge a branch**

```
git merge <branch> [--no-ff]
```

To **rebase** the current branch with its upstream branch
The local commits can be reworked (squash, edit, move...) during the interactive mode.

```
git rebase [-i] <upstream>
```

To **revert some changes**

```
git revert <commit>...
```


### Useful Aliases

{{{multiexcerpt 'git-aliases' page='Installing Git'}}}

### Command Mappings for a Mercurial User

Here are simple commands and correspondences between Mercurial (we were used to) and Git:

See [Git Hg rosetta stone](https://github.com/sympy/sympy/wiki/Git-hg-rosetta-stone) and [Cheat sheets](http://cheat.errtheblog.com/s/git).

{{#> panel type='code' heading='Show file content in a given revision <=> hg cat'}}

```
git show ref[:file]...
```

{{/panel}}{{#> panel type='code' heading='Apply the changes introduced by some existing commits <=> hg transplant'}}

```
git cherry-pick <commit>...
```

{{/panel}}{{#> panel type='code' heading='Undo last commit (without having pushed anything to public repo) <=> hg rollback'}}

```
git reset --soft HEAD~1
```

{{/panel}}

## Nuxeo Common Usage and Best Practices

### Convenient Shell Scripts

At root of the Nuxeo Platform, the script [scripts/gitfunctions.sh](https://github.com/nuxeo/nuxeo/blob/master/scripts/gitfunctions.sh) provides some convenient Shell functions for use on Nuxeo projects version controlled under Git.

```
source <(curl -s https://raw.githubusercontent.com/nuxeo/nuxeo/stable/scripts/gitfunctions.sh)
# or source /path/to/nuxeo/scripts/gitfunctions.sh

gitf -?
Usage: gitf [-r] [-q] [-h|-?] <[--] Git instructions>
Recursively executes the given Git command on the current and its direct children Git repositories.

	-h,-?	Show this help message and exit.
	-q	Quiet mode (default is verbose).
	-r	The recurse will continue on all children Git repositories.
	--	Optional separator between the options and the instructions which may start with a dash.

gitfa -?
Usage: gitfa [-q] [-h|-?] <[--] Git instructions>
Recursively executes the given Git command on the current, its direct children Git repositories and browse the child Maven modules of $PARENT_MODULES directories.

	-h,-?	Show this help message and exit.
	-q	Quiet mode (default is verbose).
	--	Optional separator between the options and the instructions which may start with a dash.
	PARENT_MODULES Environment variable. Defaults to 'addons addons-core' if not set.
	LIST_<parent module> Environment variable that can be set to restrict the children modules to a fixed list. For instance: LIST_ADDONS_CORE="nuxeo-core-storage-marklogic" or LIST_ADDONS="nuxeo-shell nuxeo-quota".

shr -?
Usage: shr [-a] [-q] [-h|-?] <[--] Shell instructions>
Recursively executes the given Shell command on the current and its direct children Git repositories.

	-h,-?	Show this help message and exit.
	-a	The recurse will continue on the child Maven modules of $PARENT_MODULES directories.
	-q	Quiet mode (default is verbose).
	--	Optional separator between the options and the instructions which may start with a dash.
	PARENT_MODULES Environment variable. Defaults to 'addons addons-core' if not set.
	LIST_<parent module> Environment variable that can be set to restrict the children modules to a fixed list. For instance: LIST_ADDONS_CORE="nuxeo-core-storage-marklogic" or LIST_ADDONS="nuxeo-shell nuxeo-quota".
```

### Main Rules and Good Practices

* Do not rewrite Git history on development and maintenance branches.
* Branch naming
    * Strictly follow Nuxeo naming policy for branches and tags
    * Tags are named `release-<semver>`
    * Create working branches named as `<TYPE>-<REFERENCE>-<SHORT_DESC>`: `fix-NXP-1234-some-expected-behavior` or "`feature-NXP-1234-some-new-feature`
    * Use the same name for a local branch than its corresponding remote branch.
* Commits
    * Reference JIRA issues in the head of commit comment.
    * Comment with a first short line, then add optionally an empty line, then as much details as you consider useful
    * When squashing other author's commits, typically during a PR, mentions are welcome in the commit comment body. </br>
    For instance:
    ```
    Co-authored-by: @username <username@users.noreply.github.com>
    Reviewed-by: @reviewer_username <reviewer_username@users.noreply.github.com>
    ```
    * Commit as a valid author (i.e. "Firstname Lastname \<email address>" with the email address being configured in your GitHub account, no matter if it's public or private).
* Merging work
    * Rebase against the upstream then ask for code review with a Pull Request
    * Consider reworking the branch before review: isolate code cleanup, squash related commits, etc.
    * When your work is achieved, rebase again then merge the branch (see [Isolated testing with ondemand-testandpush jobs]({{page page='isolated-testing'}})).
    * Unique and very few commits can be merged as fast-forward, else creating a merge commit is recommended for readability.
    * Optionally delete the remaining branch, else it will be automatically done after a short while once the related JIRA ticket is resolved.


## Advanced Usage and Specific Use Cases

### Some Useful Commands

{{#> panel type='code' heading='Adding a remote repository to a local Git repository'}}

```
git remote add origin git@github.com:nuxeo/nuxeo.git
```

{{/panel}}{{#> panel type='code' heading='Pushing to master branch on remote repository with alias origin'}}

```
git push -u origin master
```

{{/panel}}{{#> panel type='code' heading='Renaming a branch'}}

```
# Rename local branch
git branch -m <oldname> <newname>

# Rename remote branch. See 'rbranch-rename' alias.
git push origin origin/<oldname>:refs/heads/<newname> :<oldname>
```

{{/panel}}{{#> panel type='code' heading='Removing a local branch'}}

```
git branch -d branch_name
```

{{/panel}}{{#> panel type='code' heading='Removing a remote branch'}}

```
# Old way
git push origin :branch_name
# New way
git push --delete branch_name
```

{{/panel}}{{#> panel type='code' heading='Removing old (stale) remote branch references'}}

```
git remote prune <remote_repository_alias>
```

{{/panel}}{{#> panel type='code' heading='Creating an annotated tag'}}

```
git tag -a <tag_name> <sha1> -m"<tag_message>"
```

{{/panel}}{{#> panel type='code' heading='Removing a tag'}}

```
git tag -d <tag_name>
```

{{/panel}}{{#> panel type='code' heading='Pushing a tag'}}

```
git push <remote_repository_alias> <tag_name>
```

{{/panel}}{{#> panel type='code' heading='Removing a remote tag'}}

```
git push <remote_repository_alias> :refs/tags/<tag_name>
```

{{/panel}}

### Checking Out Pull Request Locally

Sometimes, a pull request needs local changes (to resolve merge or rebase conflicts, to fix or complete the commits, to run tests...). You can get GitHub instructions at the bottom of the pull request page, near the merge button: click on "command line instructions". Here is a summary of those instructions and some alternate commands.

Let's assume that the user name is `contributor` and he's issuing the pull request number `#67` from the branch `fix-NXP-12345-some-stuff` in his forked repository <https://github.com/contributor/nuxeo.git> to branch master in <http://github.com/nuxeo/nuxeo.git>.

#### As a Simple Patch

For simple cases, you can locally apply the pull-request as a patch (see [GitHub documentation](https://help.github.com/articles/using-pull-requests#merging-a-pull-request)):

```bash
git checkout -b fix-NXP-12345-some-stuff master
curl -L https://github.com/nuxeo/nuxeo/pull/67.patch | git am
```

#### As a Branch

```
# Fetch details are needed only if you didn't configure remote.origin.fetch at global or repository level
git fetch origin +pull/67/head:pull/67

# Pull requests can be checked out like a standard branch
git checkout pull/67

# You can list the modified files and open them in your preferred IDE (here using Eclipse for a PR on master)
git diff origin/master --name-only --format="" --diff-filter=d | xargs eclipse
```

#### Fetch the Pull Request Changes

```bash
git checkout -b fix-NXP-12345-some-stuff master
git pull origin pull/67/head

```

#### Fetch the Pull Request Changes (Alternative)

{{#> panel type='code' heading='Alternative command fetching from the contributor\'s repository instead of fetching from the pull request'}}

```
git checkout -b fix-NXP-12345-some-stuff master
git pull https://github.com/contributor/nuxeo.git fix-NXP-12345-some-stuff
```

{{/panel}}

### Removing Content From Git History

{{#> callout type='warning' }}

This action modifies the Git history! All commits previously containing the unwanted files will be rewritten.

{{/callout}}

{{#> panel type='code' heading='Removing files from Git history'}}

```
git filter-branch --index-filter 'git rm -r --cached --ignore-unmatch files_to_remove' HEAD
git rm -r --cached files_to_remove
git commit
```

{{/panel}}

See also [BFG Repo-Cleaner](https://rtyley.github.io/bfg-repo-cleaner/) which provides very much faster and somehow simpler (user-friendlier) commands for a few high-level features.

### Converting a Mercurial Repository to a Git Repository

Here is an example using `hg-fast-export` with Nuxeo DAM Mercurial repository:

{{#> panel type='code' heading='Migrating from Mercurial to Git'}}

```
git clone git://repo.or.cz/fast-export.git
git init new-git-repository
cd new-git-repository
/path/to/fast-export/hg-fast-export.sh -r /path/to/old-hg-repository

```

{{/panel}}

More info in [this blog post](http://hedonismbot.wordpress.com/2008/10/16/hg-fast-export-convert-mercurial-repositories-to-git-repositories).

{{#> panel type='code' heading='Post migration cleanup '}}

```
for i in `git branch | grep -v master`; do git log -1 --pretty="format:$i%x09%s%n" $i | grep '[Tt]ag[g ]' | cut -f 1; done | while read i; do git branch -d $i; done
# Replace last occurrence of "-d" with "-D" to force deletion

```

{{/panel}}

**Notes/tips:**

*   "default" Mercurial branch will be mapped to "master" Git branch. If you were not using the "default" branch but for instance "5.5" or if the "master" should start pointing at "5.5", do:

    ```
    git checkout -B master 5.5
    # Optionally commit the new branch creation after having updated its content (see below).

    ```

    {{#> panel type='code' heading='Moving .hgignore to .gitignore'}}

    ```
    git mv .hgignore .gitignore
    # Edit and remove non-Git configuration from .gitignore, such as "syntax:glob".

    ```

    {{/panel}}{{#> panel type='code' heading='Adding remote repository; pushing branches and tags'}}

    ```
    git remote add origin git@github.com:nuxeo/some_repository.git
    git push --all origin
    git push --tags
    git branch --set-upstream master origin/master
    ```

    {{/panel}}
*   Set the Mercurial repository as deprecated.
*   Activate GitHub hooks after having pushed the migration.

### Extracting Part(s) of an Existing Repository to a New Repository

Clone the repository, then:

For one directory:

```
git filter-branch --subdirectory-filter dir-to-extract --tag-name-filter cat --prune-empty -- --all
```

For multiple directories:

```
git filter-branch --index-filter 'git rm  --ignore-unmatch --cached -qr -- . && git reset -q $GIT_COMMIT -- dir1-to-extract dir2-to-extract dir3-to-extract' --tag-name-filter cat --prune-empty -- --all
```

Finally:

```
for i in $(git branch -r | sed "s/.*origin\///"); do git branch -t $i origin/$i; done
git remote rm origin
git reset --hard
git for-each-ref --format="%(refname)" refs/original/ | xargs -n 1 git update-ref -d
git reflog expire --expire=now --all
git gc --aggressive --prune=now
```

The new repository is ready for push.

You can remove the extracted directory from the old repository (`git rm ...`).

### Merging Two Repositories

{{#> callout type='warning' }}

See {{jira server='Nuxeo Issue Tracker' key='NXP-15865'}} for a workaround to the issue [https://github.com/robinst/git-merge-repos/issues/3](https://github.com/robinst/git-merge-repos/issues/3)

Prepare script is available: [https://gist.github.com/jcarsique/29ca0df9166926183e2f](https://gist.github.com/jcarsique/29ca0df9166926183e2f)

If you work on a local clone, you must remove all local branches or ensure that they are up-to-date. See [http://aanandprasad.com/git-up/](http://aanandprasad.com/git-up/).

{{/callout}}

There are two main merging solutions:

*   Merge history for paths: the commits are rewrote so that everything is as if the two repositories were merged since their beginning.
*   Merge branch heads: the commit IDs are unchanged. The branches existing in the two repositories are merged at their HEAD. History for each repository is kept unchanged.

On open source projects, with commit IDs referenced from public issues, the latter solution is preferred.

Clone [https://github.com/robinst/git-merge-repos](https://github.com/robinst/git-merge-repos)

Run `./run.sh /path/to/repo1:. /path/to/repo2:.`.

The result is in a sub-directory named `merged-repo`. Add the remote and push the branches **without force option**, then the tags.

```
# Update .gitignore and remove those in sub-directories
git remote add origin ...
# Optimize repository
git reflog expire --expire=now --all
git gc --aggressive --prune=now
git fsck
# Check outgoing changes
git push --all -n origin 2>&1 | grep -E "deleted|rejected"
# Merge remote changes per branch if necessary; see also git-up command to update all local branches
# Push changes
git push --all origin
git push --tags -f origin
```

{{#> callout type='warning' }}

If you need to `rebase` (or `pull --rebase`) some local branch (after repositories merge), then you must use the `rebase --preserve-merges` option (or `pull --rebase=preserve`).

Please disable GitHub email notifications before push and re-enable after push.

{{/callout}}

{{#> callout type='note' }}

After the merge, the Jenkins job running on your repository will probably add comments on JIRA issues referenced in the rewritten history: these comments could be nice to have, but if you do not want them, you should disable the "Update relevant JIRA issues" options on the job, at its first run after the merge.

{{/callout}}



#### Using Another Local Clone as Staging

You may want to push from `merged-repo` to a local clone of `foo`:

```
cd /path/to/foo
git checkout --detach
git fetch --tags /path/to/merged-repo
cd /path/to/merged-repo
git push --all /path/to/foo

```

The `foo` repository is now ready for push to remote. Of course, you will often want to finalize the merge first (add modules to a common POM, remove useless `.gitignore`...)

{{#> callout type='warning' }}
If there was a remote conflicting change, then you can rebase the new branch(es).

If you had local changes in `foo`, then you may encounter conflicts at push:

<pre>To /path/to/foo
 ! [rejected]        some-conflicting-branch -> some-conflicting-branch (fetch first)
error: failed to push some refs to '/path/to/foo'
hint: Updates were rejected because the remote contains work that you do
hint: not have locally. This is usually caused by another repository pushing
hint: to the same ref. You may want to first integrate the remote changes
hint: (e.g., 'git pull ...') before pushing again.
hint: See the 'Note about fast-forwards' in 'git push --help' for details.</pre>

In that case, you will have to manually solve the conflict: choosing the branch to keep, optionally merging/cherry-picking some commits...

For instance, to forget the local changes:

```
cd /path/to/foo
git fetch -f /path/to/merged-repo some-conflicting-branch:some-conflicting-branch
```

{{/callout}}

#### Walking Through History After Merge

After merge, the resulting repository will have two distinct history trees that converge into the future unique history. The drawback is that it is not easy to browse the old history of the imported repository.  

In the following example, we have merged a repository `B` under a new folder `repo-b/` of the repository `A`.
```
$ tree -L 2
.
├── repo-b/      # Imported content of B, shifted.
│   ├── pom.xml
│   └── ...
├── pom.xml
└── ...          # Original content of A, unchanged.

$ git show --summary
commit eb9a482ef762372b7ebc868045aa210a8b553d24
Merge: cafb9624c 943add6f0

    Merge branch 'master' from multiple repositories
    Repositories:
            A
            B

# cafb9624c is the HEAD of the original content (repo A)
# 943add6f0 is the HEAD of the imported content (repo B)

$ git log --graph --pretty=format:'%h -%d %s' --simplify-by-decoration
*   eb9a482ef - (HEAD -> master) Merge branch 'master' from multiple repositories
|\  
| * 3d3ebc4a0 - first commit on B
* cafb9624c - (origin/master) last commit on A
```

Here are some history browsing Git commands with their behavior regarding the "old" history (before the merge of repositories)
```
# To walk through both trees, use --follow starting from a commit post-merge

$ git log --oneline --follow -- pom.xml|grep 3d3ebc4a0
3d3ebc4a0 NXP-14853: First commit.

$ git log --oneline --follow -- repo-b/pom.xml|grep 3d3ebc4a0
3d3ebc4a0 NXP-14853: First commit.

$ git log --oneline --follow -- repo-b/pom.xml|wc -l
476
$ git log --oneline --follow -- pom.xml|wc -l
476

# To walk through the old trees, use a pre-merge commit: cafb9624c for repo A and 943add6f0 for repo B

$ git log --oneline cafb9624c --follow -- pom.xml|wc -l
445
$ git log --oneline 943add6f0 --follow -- pom.xml|wc -l
30

# 3d3ebc4a0 is not in the old tree A but in tree B
$ git log --oneline cafb9624c --follow -- pom.xml|grep 3d3ebc4a0
$ git log --oneline 943add6f0 --follow -- pom.xml|grep 3d3ebc4a0
3d3ebc4a0 NXP-14853: First commit.
```

### Normalize End of Lines

#### Per-Branch Normalization

Git allows to apply automatic checks on end of lines depending on the file attributes (see [http://git-scm.com/docs/gitattributes/](http://git-scm.com/docs/gitattributes/)).

{{#> panel type='code' heading='Ensure correct EOL on \*.sh and \*.bat files'}}

```bash
# End-of-line conversion like in https://raw.githubusercontent.com/nuxeo/nuxeo/master/.gitattributes
echo "*.sh eol=lf" >>.gitattributes
echo "*.bat eol=crlf" >>.gitattributes
rm .git/index
git reset
git add -u
git add .gitattributes
git ci -m'Introduce end-of-line normalization'
```

{{/panel}}

That will automatically convert end of lines in `*.sh` and `*.bat` files in the branch containing the `.gitattributes` file.

#### Per-Repository Normalization

You can set such an automatic conversion on all branches with the following:

{{#> panel type='code' heading='Automatic EOL conversion on all branches'}}

```bash
echo "*.sh eol=lf" >>.git/info/attributes
echo "*.bat eol=crlf" >>.git/info/attributes
```

{{/panel}}

The `.git/info/attributes` file is not committed but local to the repository.

{{#> callout type='warning' }}

Note however that this configuration will likely cause conflicts on merge (or rebase). In such a case, the easier solution is to temporarily rename `.git/info/attributes`, end the merge (or rebase), then put back the attributes file.

{{/callout}}

#### Global Enforcement

See [Installing Git / Git Global Configuration]({{page page='installing-git'}}) for a setting `core.autocrlf`, `core.safecrlf`... parameters to enforce the EOL checks on all Git repositories.

#### Useful Tools

The following commands are very useful for dealing with EOL: `file`, `unix2dos` and `dos2unix`.

### Diff on Binary Files

It is possible to tell Git how to convert binary data to a text format that can be compared via the normal diff.

#### PNG and DOCX

Here is a sample configuration for `.docx` and `.png` files (from [http://git-scm.com/book/en/v2/Customizing-Git-Git-Attributes](http://git-scm.com/book/en/v2/Customizing-Git-Git-Attributes)):

1.  Install [`docx2txt`](http://docx2txt.sourceforge.net/) and `exiftool`
2.  Create a `docx2txt` wrapper script and mark it as executable:

    {{#> panel type='code' heading='~/bin/docx2txt'}}

    ```bash
    #!/bin/bash
    docx2txt.pl $1 -
    ```

    {{/panel}}

    `chmod a+x ~/bin/docx2txt`

3.  Tell Git which binary files to convert:

    {{#> callout type='info' }}

    Use `.git/info/attributes` if you don&rsquo;t want the attributes file committed with your project, else use `.gitattributes`

    {{/callout}}{{#> panel type='code' heading='.git/info/attributes or .gitattributes'}}

    ```text
    *.docx diff=word
    *.png diff=exif
    ```

    {{/panel}}
4.  Tell Git how to convert:

    ```
    git config --global diff.word.textconv docx2txt
    git config --global diff.exif.textconv exiftool
    ```

Here are the outputs with and without the above Git attributes:

{{#> panel type='code' heading='Default diff on docx'}}

```text
$ git show 281e4f470bb0e8fc1d43b9350e72063030d15f66 --oneline  -- nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx
281e4f4 NXP-9331: Get rid of cyclic dependency by isolating tests in nuxeo-core-convert-plugins-test
diff --git a/nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx b/nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx
new file mode 100644
index 0000000..ad1b4af
Binary files /dev/null and b/nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx differ
```

{{/panel}}{{#> panel type='code' heading='Smart diff on docx'}}

```text
$ git show 281e4f470bb0e8fc1d43b9350e72063030d15f66 --oneline  -- nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx
281e4f4 NXP-9331: Get rid of cyclic dependency by isolating tests in nuxeo-core-convert-plugins-test
diff --git a/nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx b/nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx
new file mode 100644
index 0000000..ad1b4af
--- /dev/null
+++ b/nuxeo-core-convert-plugins-test/src/test/resources/test-docs/hello.docx
@@ -0,0 +1 @@
+Hello world !
```

{{/panel}}{{#> panel type='code' heading='Default diff on PNG'}}

```text
$ git show 025a2bda872a228d2ee07b8830e2472088ae43a5 --oneline -- nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png
025a2bd NXP-15048: Update logo, flavors and login page for new branding
diff --git a/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png b/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png
index a28e89d..b38c0e0 100644
Binary files a/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png and b/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png differ
```

{{/panel}}{{#> panel type='code' heading='Smart diff on PNG'}}

```text
$ git show 025a2bda872a228d2ee07b8830e2472088ae43a5 --oneline -- nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png
025a2bd NXP-15048: Update logo, flavors and login page for new branding
diff --git a/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png b/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png
index a28e89d..b38c0e0 100644
--- a/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png
+++ b/nuxeo-platform-webapp/src/main/resources/web/nuxeo.war/img/nuxeo_logo.png
@@ -1,15 +1,15 @@
 ExifTool Version Number         : 9.69
-File Name                       : QoqEHp_nuxeo_logo.png
+File Name                       : EYPa9v_nuxeo_logo.png
 Directory                       : /tmp
-File Size                       : 4.9 kB
+File Size                       : 8.0 kB
 File Modification Date/Time     : 2015:01:30 15:39:32+01:00
 File Access Date/Time           : 2015:01:30 15:39:32+01:00
 File Inode Change Date/Time     : 2015:01:30 15:39:32+01:00
 File Permissions                : rw-------
 File Type                       : PNG
 MIME Type                       : image/png
-Image Width                     : 236
-Image Height                    : 52
+Image Width                     : 227
+Image Height                    : 40
 Bit Depth                       : 8
 Color Type                      : RGB with Alpha
 Compression                     : Deflate/Inflate
@@ -18,8 +18,8 @@ Interlace                       : Noninterlaced
 Software                        : Adobe ImageReady
 XMP Toolkit                     : Adobe XMP Core 5.3-c011 66.145661, 2012/02/06-14:56:27
 Creator Tool                    : Adobe Photoshop CS6 (Macintosh)
-Instance ID                     : xmp.iid:659F991F084311E4A7D7A0843068B9FA
-Document ID                     : xmp.did:659F9920084311E4A7D7A0843068B9FA
-Derived From Instance ID        : xmp.iid:659F991D084311E4A7D7A0843068B9FA
-Derived From Document ID        : xmp.did:659F991E084311E4A7D7A0843068B9FA
-Image Size                      : 236x52
+Instance ID                     : xmp.iid:394FADE624C911E48679ADB8C76F05E6
+Document ID                     : xmp.did:394FADE724C911E48679ADB8C76F05E6
+Derived From Instance ID        : xmp.iid:EBA4519B23A511E48679ADB8C76F05E6
+Derived From Document ID        : xmp.did:EBA4519C23A511E48679ADB8C76F05E6
+Image Size                      : 227x40
```

{{/panel}}

#### ZIP

    ```
    git config --global diff.zip.textconv "unzip -c -a"
    echo "*.zip diff=zip" >> .gitattributes
    ```

### Git Large File Storage

GitHub will warn you when pushing files larger than 50 MB. You will not be allowed to push files larger than 100 MB.
Actually, storing binaries in Git is a bad practice. The usage pattern should be reviewed in order to fetch external data from Nexus for instance.

However, if you think you legitimately need to store (fat) binaries in Git, then there are solutions reducing the inconveniences: `git-annex`, `git-fat`, `Git LFS`, `git-bigfiles`, `git-media`, `git-bigstor`, `git-sym`... The three firsts being the most promising.
**Nuxeo choose Git LFS: [https://git-lfs.github.com/](https://git-lfs.github.com/)**

#### Configuration

The following should avoid running `git lfs install` on each Git repository.

```
git config --global filter.lfs.required true
git config --global filter.lfs.clean "git-lfs clean %f"
git config --global filter.lfs.smudge "git-lfs smudge %f"
```

#### Batch Download

LFS has the batch mode for downloading files from a server. But it does not work on clone and checkout due to limitation of Git&rsquo;s smudge filters. You can skip LFS&rsquo;s smudge filter and fetch LFS objects on demand:

```
# change the smudge filter configuration
git config --global filter.lfs.smudge "git-lfs smudge --skip %f"
# check
git lfs env

# fetch LFS objects after checkout or clone:
git lfs fetch # downloads objects with batch mode
git lfs checkout # changes objects to binary files
```

#### Issues

{{#> callout type='warning' }}

Commands naming is not consistent between Git and Git LFS!

{{/callout}}

Git LFS does not seem very stable yet and it has some inconsistencies with Git when mixing LFS and Git-native binaries. You may encounter modified or untracked binaries while you didn't change them.

See [https://shuhrat.github.io/programming/git-lfs-tips-and-tricks.html](https://shuhrat.github.io/programming/git-lfs-tips-and-tricks.html), [https://github.com/tarmolov/git-hooks-js](https://github.com/tarmolov/git-hooks-js) to configure and share a safety pre-commit hook.

See [https://github.com/bozaro/git-lfs-migrate](https://github.com/bozaro/git-lfs-migrate) to migrate an existing repository.
