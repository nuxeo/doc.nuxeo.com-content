---
title: Microsoft SQL Server
review:
    comment: ''
    date: '2017-12-15'
    status: ok
labels:
    - lts2016-ok
    - database
    - kleturc
    - sql
    - multiexcerpt-include
    - lts2017-ok
toc: true
confluence:
    ajs-parent-page-id: '3342340'
    ajs-parent-page-title: Database Configuration
    ajs-space-key: NXDOC
    ajs-space-name: Nuxeo Platform Developer Documentation
    canonical: Microsoft+SQL+Server
    canonical_source: 'https://doc.nuxeo.com/display/NXDOC/Microsoft+SQL+Server'
    page_id: '3867154'
    shortlink: EgI7
    shortlink_source: 'https://doc.nuxeo.com/x/EgI7'
    source_link: /display/NXDOC/Microsoft+SQL+Server
tree_item_index: 300
version_override:
    LTS 2015: 710/admindoc/microsoft-sql-server
    '6.0': 60/admindoc/configuring-ms-sql-server
    '5.8': 58/admindoc/configuring-ms-sql-server
history:
    -
        author: Solen Guitter
        date: '2016-09-01 10:03'
        message: ''
        version: '49'
    -
        author: Solen Guitter
        date: '2016-05-13 14:42'
        message: ''
        version: '48'
    -
        author: Solen Guitter
        date: '2016-05-13 14:41'
        message: ''
        version: '47'
    -
        author: Manon Lumeau
        date: '2015-12-11 09:12'
        message: ''
        version: '46'
    -
        author: Florent Guillaume
        date: '2015-12-09 13:58'
        message: ''
        version: '45'
    -
        author: Alain Escaffre
        date: '2015-12-04 13:43'
        message: ''
        version: '44'
    -
        author: Solen Guitter
        date: '2015-03-25 10:05'
        message: ''
        version: '43'
    -
        author: Thierry Martins
        date: '2014-10-31 15:14'
        message: title capitalization
        version: '42'
    -
        author: Thierry Martins
        date: '2014-10-31 15:07'
        message: stopwords conf
        version: '41'
    -
        author: Solen Guitter
        date: '2014-10-13 17:39'
        message: Updated supported versions for 6.0
        version: '40'
    -
        author: Solen Guitter
        date: '2014-08-25 14:56'
        message: Remove 5.4 reference
        version: '39'
    -
        author: Solen Guitter
        date: '2014-07-24 15:50'
        message: ''
        version: '38'
    -
        author: Florent Guillaume
        date: '2013-11-19 19:41'
        message: ''
        version: '37'
    -
        author: Solen Guitter
        date: '2013-09-25 11:26'
        message: Fixed formatting
        version: '36'
    -
        author: Benoit Delbosc
        date: '2013-09-24 18:11'
        message: ''
        version: '35'
    -
        author: Benoit Delbosc
        date: '2013-09-11 18:27'
        message: ''
        version: '34'
    -
        author: Benoit Delbosc
        date: '2013-09-11 17:55'
        message: Add isolation information and lock escalation
        version: '33'
    -
        author: Solen Guitter
        date: '2013-07-23 14:09'
        message: ''
        version: '32'
    -
        author: Florent Guillaume
        date: '2013-07-18 16:00'
        message: format
        version: '31'
    -
        author: Florent Guillaume
        date: '2013-07-18 15:59'
        message: supported versions
        version: '30'
    -
        author: Florent Guillaume
        date: '2013-07-18 15:55'
        message: collation stuff
        version: '29'
    -
        author: Florent Guillaume
        date: '2013-07-17 16:50'
        message: added analyzer config
        version: '28'
    -
        author: Florent Guillaume
        date: '2013-04-11 15:37'
        message: Migration of unmigrated content due to installation of a new plugin
        version: '27'
    -
        author: Florent Guillaume
        date: '2013-04-11 15:37'
        message: ''
        version: '26'
    -
        author: Vladimir Pasquier
        date: '2012-11-09 12:19'
        message: ''
        version: '25'
    -
        author: Vladimir Pasquier
        date: '2012-11-09 12:13'
        message: ''
        version: '24'
    -
        author: Vladimir Pasquier
        date: '2012-11-09 12:09'
        message: ''
        version: '23'
    -
        author: Florent Guillaume
        date: '2012-06-04 14:05'
        message: Migration of unmigrated content due to installation of a new plugin
        version: '22'
    -
        author: Florent Guillaume
        date: '2012-06-04 14:05'
        message: Migration of unmigrated content due to installation of a new plugin
        version: '21'
    -
        author: Florent Guillaume
        date: '2012-06-04 14:05'
        message: Migrated to Confluence 4.0
        version: '20'
    -
        author: Florent Guillaume
        date: '2012-06-04 14:05'
        message: added WITH ROLLBACK IMMEDIATE
        version: '19'
    -
        author: Solen Guitter
        date: '2012-05-10 12:14'
        message: ''
        version: '18'
    -
        author: Solen Guitter
        date: '2012-05-10 11:19'
        message: Added related pages
        version: '17'
    -
        author: Solen Guitter
        date: '2012-03-28 18:28'
        message: ''
        version: '16'
    -
        author: Solen Guitter
        date: '2011-12-10 09:50'
        message: ''
        version: '15'
    -
        author: Benoit Delbosc
        date: '2011-09-01 11:21'
        message: ''
        version: '14'
    -
        author: Benoit Delbosc
        date: '2011-07-29 18:42'
        message: require a CS collation
        version: '13'
    -
        author: Florent Guillaume
        date: '2011-07-28 17:07'
        message: ''
        version: '12'
    -
        author: Benoit Delbosc
        date: '2011-07-28 17:02'
        message: update on db collation
        version: '11'
    -
        author: Benoit Delbosc
        date: '2011-07-28 16:46'
        message: Update for read acls optimization
        version: '10'
    -
        author: Wojciech Sulejman
        date: '2011-03-08 20:42'
        message: ''
        version: '9'
    -
        author: Solen Guitter
        date: '2011-03-04 17:22'
        message: ''
        version: '8'
    -
        author: Florent Guillaume
        date: '2010-12-29 11:34'
        message: ''
        version: '7'
    -
        author: Julien Carsique
        date: '2010-10-29 18:18'
        message: 'moved driver information to [NXDOC:Configuring Nuxeo EP]'
        version: '6'
    -
        author: Julien Carsique
        date: '2010-10-29 12:23'
        message: Add jdbc driver information
        version: '5'
    -
        author: Florent Guillaume
        date: '2010-08-20 12:45'
        message: ''
        version: '4'
    -
        author: Florent Guillaume
        date: '2010-08-20 12:40'
        message: ''
        version: '3'
    -
        author: Florent Guillaume
        date: '2010-08-20 12:34'
        message: ''
        version: '2'
    -
        author: Florent Guillaume
        date: '2010-08-20 12:29'
        message: ''
        version: '1'

---
Nuxeo supports the following version of Microsoft SQL Server:

{{{multiexcerpt 'SQLserver-supported' page='Compatibility Matrix'}}}

## System Database Collation

We have observed an incorrect behavior (in particular with full-text search) if the SQL Server `master` database is not configured with a case-insensitive collation (a collation name with "`CI`").

To make sure this is the case, use:

```sql
SELECT collation_name FROM sys.databases WHERE name = 'master'
```

For instance the following collations have been checked to work correctly:

- `SQL_Latin1_General_CP1_CI_AS`
- `French_CI_AS`

## Database Collation

To work properly Nuxeo needs to have some columns with a case-sensitive collation.

To make sure this is the case, use:

```sql
SELECT collation_name FROM sys.databases WHERE name = 'nuxeo' -- or your custom database name
```

You need a case-sensitive collation (a collation name with "`CS`"), like `French_CS_AS`.

If this is not the case for your existing database you can change it like this:

```
ALTER DATABASE nuxeo COLLATE French_CS_AS

```

If you get database error related to rights issues, you can set it as a single user owner:

```
ALTER DATABASE nuxeo SET SINGLE_USER
WITH ROLLBACK IMMEDIATE
GO
ALTER DATABASE nuxeo COLLATE French_CS_AS
GO
ALTER DATABASE nuxeo SET MULTI_USER
```

## Row Versioning-Based Transaction Isolation

To prevent locking and deadlocking problems, you need to [enable the row versioning-based isolation levels](http://technet.microsoft.com/en-us/library/ms175095.aspx). With row versioning, readers do not prevent other readers or writers from accessing the same data. Similarly, the writers do not block readers. However, writers will block each other. Whenever a transaction is started, Nuxeo adds a `SET TRANSACTION ISOLATION LEVEL READ COMMITTED` so the transaction sees only data committed before the query began.

To enable the row versioning submit the following SQL commands:

```
ALTER DATABASE nuxeo SET ALLOW_SNAPSHOT_ISOLATION ON;
ALTER DATABASE nuxeo SET READ_COMMITTED_SNAPSHOT ON;

```

If you do not execute the above commands, the following error will occur at Nuxeo startup:

```
Snapshot isolation transaction failed accessing database 'nuxeo' because snapshot isolation is not allowed in this database. Use ALTER DATABASE to allow snapshot isolation.

```

Note that there must be no other open connection in the database until `ALTER DATABASE` is complete, otherwise the last command above will hang. You can work around this (when executing the command from SQL Server Management Studio for instance) by adding `WITH ROLLBACK IMMEDIATE`:

```
ALTER DATABASE nuxeo SET READ_COMMITTED_SNAPSHOT ON WITH ROLLBACK IMMEDIATE;

```

## Recovery Model

A recovery model is a database property that controls how transactions are logged, whether the transaction log requires (and allows) backing up, and what kinds of restore operations are available. Three recovery models exist: `simple`, `full`, and `bulk_logged`. For more information, visit  [Recovery Models (SQL Server) on Microsoft Documentation ](https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/recovery-models-sql-server?view=sql-server-2017).

By default, recovery model is `full`, so you can get performance issues. You may want to change to the `simple` model if this is the case, but please consult your database administrator first.

**Mode View:**

```sql
SELECT recovery_model_desc FROM sys.databases WHERE name = 'nuxeo';
```

**Mode Update:**

```sql
USE master;
ALTER DATABASE nuxeo SET RECOVERY SIMPLE;
```

## Full-Text

If you have configured your Nuxeo Platform instance to index full-text using the SQL database (by disabling the default configuration which uses Elasticsearch),
you will need to make sure that your SQL Server instance has full-text search configured, which is an optional component during installation. See [Full-Text Search on Microsoft Documentation](https://docs.microsoft.com/en-us/sql/relational-databases/search/full-text-search) for details.

Otherwise similar errors will occur:

{{#> panel type='code' heading='SQL Server Msg 7601'}}
```
Cannot use a CONTAINS or FREETEXT predicate on table or indexed view 'fulltext' because it is not full-text indexed.
```
{{/panel}}

{{#> panel type='code' heading='SQL Server Msg 7616'}}
```
Full-Text Search is not enabled for the current database. Use sp_fulltext_database to enable full-text search for the database. The functionality to disable and enable full-text search for a database is deprecated. Please change your application.
```
{{/panel}}

Here is the French version of these messages, for reference:

{{#> panel type='code' heading='SQL Server Msg 7601'}}
```
Impossible d'utiliser le prédicat CONTAINS ou FREETEXT sur table ou vue indexée 'fulltext', car il n'y a pas d'index de texte intégral.
```
{{/panel}}

{{#> panel type='code' heading='SQL Server Msg 7616'}}
```
La recherche en texte intégral n'est pas activée dans la base de données en cours. Utilisez `sp_fulltext_database` pour l'activer sur cette base de données. La fonctionnalité de désactivation et d'activation d'une recherche en texte intégral pour une base de données est désapprouvée. Modifiez votre application.
```
{{/panel}}

You can verify if your SQL Server instance has its full-text feature installed before creating your database:
```sql
SELECT SERVERPROPERTY('IsFullTextInstalled');
```

### Full-Text Catalog

Nuxeo uses a full-text catalog named `nuxeo` by default, this can be changed in the Nuxeo configuration files (see [configuration details]({{page space='kb' page='configure-nuxeo-53-with-vcs-and-sql-server'}})).

### Full-Text Analyzer

The language used to analyze full-text (called a LANGUAGE in SQL Server parlance) can be specified in the configuration for the database, instead of "english" in the section `<fulltext analyzer="english">`. The available languages in your database can be listed by using:

```sql
SELECT alias FROM sys.syslanguages
```

### Incorrect Results Using Stopwords

If you do not get the expected results with a keyword like "table of contents", the problem could come from how SQL Server handles the stopwords ("of" in this case). It could be necessary to run this code:

```sql
USE master;
GO
EXEC sp_configure 'transform noise words',1
RECONFIGURE WITH OVERRIDE;
```

## Additional Maintenance Operation

The SQL Server back end comes with ACL (Access Control List) optimization. This optimization functions with cache tables to store rights for each users and keep tracking of documents and rights changes. Theses data will be reset when the server is started.

For long-running instances or to perform a hot backup without these unnecessary data, you can invoke the following stored procedure:

```sql
USE nuxeo;
EXEC dbo.nx_vacuum_read_acls;

```

You can also exclude the following tables from your backup:

- `aclr`
- `aclr_modified`
- `aclr_permissions`
- `aclr_user_map`
- `aclr_user`

### Deadlock and Lock Escalation

SQL Server is doing lock escalation: converting many row level locks to page lock or table lock. When doing conflicting write operations, this can create deadlocks even when working on distinct data.

You can have more information on deadlock by enabling the following traces:

```sql
 DBCC TRACEON(1222,-1);
 DBCC TRACEON(1204,-1);
```

Then you can try to disable the lock escalation on the table impacted by deadlocks:

```sql
ALTER TABLE mytable SET (LOCK_ESCALATION=DISABLE)
```

### Indexes Maintenance

If the indexes are fragmented then the query response will be slow and the data storage will require more disk space. Microsoft recommends reorganizing an index with a fragmentation between 5% and 30%, and rebuilding an index with a fragmentation of more than 30%. Database administrators should always make sure that fragmentation of indexes is handled on time.

## Limitations

Microsoft SQL Server is a good database however it has a few unfortunate hiccups.

Here are some limitations in the context of the Nuxeo Platform:

- Its [snapshot isolation](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/snapshot-isolation-in-sql-server) level is insufficiently isolated and not comparable to other MVCC databases, and may sometimes cause errors during concurrent writes.
- It is [infamous](http://stackoverflow.com/questions/872731/sql-server-lock-escalation-issue#872808) for its lock escalation problems that cause no end of troubles and is a very poor locking design in the first place ([MS184286](https://msdn.microsoft.com/en-us/library/ms184286.aspx)).
- Only one full-text index is allowed per table ([MS187317](http://technet.microsoft.com/en-us/library/ms187317%28v=sql.100%29.aspx)).
- Full-text indexing cannot be configured to be done synchronously with transaction commits.
- It does not support circular ON CASCADE DELETE constraints ([KB321843](http://support.microsoft.com/kb/321843)).

* * *

{{#> panel heading='Related pages'}}

- [Connecting Nuxeo to the Database]({{page page='connecting-nuxeo-to-the-database'}})
- [Examples of SQL Generated by VCS]({{page page='examples-of-sql-generated-by-vcs'}})
{{/panel}}
