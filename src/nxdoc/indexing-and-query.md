---
title: Indexing and Query
review:
    comment: ''
    date: ''
    status: ok
toc: true
confluence:
    ajs-parent-page-id: '22380898'
    ajs-parent-page-title: Developer Documentation Center
    ajs-space-key: NXDOC60
    ajs-space-name: Nuxeo Platform Developer Documentation â€” 6.0
    canonical: Indexing+and+Query
    canonical_source: 'https://doc.nuxeo.com/display/NXDOC60/Indexing+and+Query'
    page_id: '22380787'
    shortlink: 84BVAQ
    shortlink_source: 'https://doc.nuxeo.com/x/84BVAQ'
    source_link: /display/NXDOC60/Indexing+and+Query
tree_item_index: 600
history:
    -
        author: Manon Lumeau
        date: '2016-07-20 14:32'
        message: 'emove children display macro '
        version: '59'
    -
        author: Solen Guitter
        date: '2015-01-23 08:55'
        message: ''
        version: '58'
    -
        author: Anonymous
        date: '2014-11-10 14:42'
        message: ''
        version: '57'
    -
        author: Benoit Delbosc
        date: '2014-11-10 11:26'
        message: ''
        version: '56'
    -
        author: Alain Escaffre
        date: '2014-11-07 10:21'
        message: ''
        version: '55'
    -
        author: Solen Guitter
        date: '2014-11-03 14:23'
        message: ''
        version: '54'
    -
        author: Solen Guitter
        date: '2014-11-03 14:17'
        message: ''
        version: '53'
    -
        author: Solen Guitter
        date: '2014-11-03 14:07'
        message: ''
        version: '52'
    -
        author: Solen Guitter
        date: '2014-11-03 14:06'
        message: Merging tables cells
        version: '51'
    -
        author: Manon Lumeau
        date: '2014-11-03 12:03'
        message: ''
        version: '50'
    -
        author: Solen Guitter
        date: '2014-11-03 09:51'
        message: ''
        version: '49'
    -
        author: Manon Lumeau
        date: '2014-11-02 22:56'
        message: ''
        version: '48'
    -
        author: Alain Escaffre
        date: '2014-11-02 22:31'
        message: ''
        version: '47'
    -
        author: Alain Escaffre
        date: '2014-11-02 22:17'
        message: ''
        version: '46'
    -
        author: Alain Escaffre
        date: '2014-11-02 22:15'
        message: ''
        version: '45'
    -
        author: Alain Escaffre
        date: '2014-11-02 22:09'
        message: ''
        version: '44'
    -
        author: Alain Escaffre
        date: '2014-11-02 22:07'
        message: ''
        version: '43'
    -
        author: Alain Escaffre
        date: '2014-11-02 22:03'
        message: ''
        version: '42'
    -
        author: Alain Escaffre
        date: '2014-11-02 21:53'
        message: ''
        version: '41'
    -
        author: Alain Escaffre
        date: '2014-11-02 21:52'
        message: ''
        version: '40'
    -
        author: Alain Escaffre
        date: '2014-11-02 21:34'
        message: ''
        version: '39'
    -
        author: Alain Escaffre
        date: '2014-11-02 21:33'
        message: ''
        version: '38'
    -
        author: Alain Escaffre
        date: '2014-11-02 21:06'
        message: ''
        version: '37'
    -
        author: Alain Escaffre
        date: '2014-11-02 19:14'
        message: ''
        version: '36'
    -
        author: Alain Escaffre
        date: '2014-11-02 19:12'
        message: ''
        version: '35'
    -
        author: Alain Escaffre
        date: '2014-11-02 19:05'
        message: ''
        version: '34'
    -
        author: Alain Escaffre
        date: '2014-11-02 19:04'
        message: ''
        version: '33'
    -
        author: Alain Escaffre
        date: '2014-11-02 16:03'
        message: ''
        version: '32'
    -
        author: Alain Escaffre
        date: '2014-11-02 15:41'
        message: ''
        version: '31'
    -
        author: Alain Escaffre
        date: '2014-10-30 16:52'
        message: ''
        version: '30'
    -
        author: Solen Guitter
        date: '2014-10-30 10:11'
        message: typos and format
        version: '29'
    -
        author: Alain Escaffre
        date: '2014-10-29 11:10'
        message: ''
        version: '28'
    -
        author: Alain Escaffre
        date: '2014-10-29 10:56'
        message: ''
        version: '27'
    -
        author: Alain Escaffre
        date: '2014-10-29 09:47'
        message: ''
        version: '26'
    -
        author: Alain Escaffre
        date: '2014-10-29 09:19'
        message: ''
        version: '25'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:43'
        message: ''
        version: '24'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:38'
        message: ''
        version: '23'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:27'
        message: ''
        version: '22'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:26'
        message: ''
        version: '21'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:23'
        message: ''
        version: '20'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:08'
        message: ''
        version: '19'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:06'
        message: ''
        version: '18'
    -
        author: Alain Escaffre
        date: '2014-10-29 00:00'
        message: ''
        version: '17'
    -
        author: Alain Escaffre
        date: '2014-10-28 18:09'
        message: ''
        version: '16'
    -
        author: Alain Escaffre
        date: '2014-10-28 17:07'
        message: ''
        version: '15'
    -
        author: Alain Escaffre
        date: '2014-10-28 17:06'
        message: ''
        version: '14'
    -
        author: Alain Escaffre
        date: '2014-09-19 14:25'
        message: ''
        version: '13'
    -
        author: Anahide Tchertchian
        date: '2013-12-04 14:48'
        message: ''
        version: '12'
    -
        author: Anahide Tchertchian
        date: '2013-12-04 14:48'
        message: link to search screen doc + rephrase
        version: '11'
    -
        author: Solen Guitter
        date: '2013-09-04 18:25'
        message: Added children pages and excerpts
        version: '10'
    -
        author: Solen Guitter
        date: '2013-09-04 17:46'
        message: ''
        version: '9'
    -
        author: Solen Guitter
        date: '2011-03-03 19:19'
        message: Migrated to Confluence 4.0
        version: '8'
    -
        author: Solen Guitter
        date: '2011-03-03 19:19'
        message: ''
        version: '7'
    -
        author: Solen Guitter
        date: '2011-03-02 18:16'
        message: ''
        version: '6'
    -
        author: Florent Guillaume
        date: '2010-12-24 17:22'
        message: ''
        version: '5'
    -
        author: Florent Guillaume
        date: '2010-12-24 14:50'
        message: ''
        version: '4'
    -
        author: Florent Guillaume
        date: '2010-11-29 10:42'
        message: ''
        version: '3'
    -
        author: Florent Guillaume
        date: '2010-11-29 10:35'
        message: ''
        version: '2'
    -
        author: Florent Guillaume
        date: '2010-11-29 10:32'
        message: ''
        version: '1'

---

## Architecture

### Data store and index

The Nuxeo Platform stores documents and their property values either in a database (VCS) or in a NoSQL database (DBS). This data is also at the same time indexed in an Elasticsearch index. To query those documents, several approaches are offered by the platform depending on whether you are from a remote application or in some Java code executed server-side. In the end, all the methods lead to two possibilities:

*   Query the data store (VCS or DBS). Queries there are "transactional", which means that the result will reflect exactly the state of the database in the transaction where the query is executed
*   Query the Elasticsearch index. This is the most scalable and efficient way to perform a query. Benchmarks show querying the repository using this Elasticsearch index scales orders of magnitude better than the database.

### A Query Language

The natural way of expressing a query in the Nuxeo Platform is with [NXQL]({{page page='nxql'}}), the Nuxeo Query Language.

```
SELECT * FROM Document WHERE
dc:contributors = ? -- simple match on a multi-valued field
AND ecm:mixinType != 'Folderish' -- use facet to remove all folderish documents
AND ecm:mixinType != 'HiddenInNavigation' -- use facet to remove all documents that should be hidden
AND ecm:isCheckedInVersion = 0 -- only get checked-out documents
AND ecm:isProxy = 0 AND -- don't return proxies
ecm:currentLifeCycleState != 'deleted' -- don't return documents that are in the trash
```

As you may see, there is no security clause, because the repository will always only return documents that the current user can see. Security filtering is built-in, so you don't have to post-filter results returned by a search, even if you use complex custom security policies.

The Nuxeo Platform is also [compatible with the CMISQL]({{page page='cmis'}}) defined in the CMIS standard.

### Page Providers: a Pagination Service&nbsp;

The framework also provides a paginated query system, the Page Providers. Page Providers are a way to expose a query defined in NXQL with additional services: pagination, parameters, maximum number of results, aggregates definition. Page providers are named and declared to the server via a contribution. More information can be found about [the page provider object]({{page page='page-providers'}}). Page providers are used in the platform in many places: Web application for browsing, for dashboards, &hellip;

Resources Endpoint are also based on a page provider. By being declarative, page providers are very easy to override. That way, most of the document lists logic of the default application can be redefined just by [overriding the corresponding page provider](http://explorer.nuxeo.org/nuxeo/site/distribution/Nuxeo%20Platform-6.0/viewExtensionPoint/org.nuxeo.ecm.platform.query.api.PageProviderService--providers). You can also build your own application in the same way. Note that in the web application, page providers are associated to a higher concept, the Content View, that wraps all the UI aspects of executing and presenting a search result (see paragraph below).

### How to Query the Repository

The following table and schema gives an overview of the different ways of querying the repository.

![](https://www.lucidchart.com/publicSegments/view/54c20ae1-0e48-471d-9eea-34930a00596d/image.png ?w=600,border=true)

1.  **Query Endpoint**

    Client side

    A resource oriented REST API that allows to execute direct NXQL queries or to use a named page provider that has been declared server side. The API returns serialised JSON documents and offers all the mechanisms provided by Nuxeo Platform Rest API (Content Enricher, Specific headers&hellip;).

    Example:
    ```
    http://NUXEO_SERVER/nuxeo/site/api/v1/query?query=select * from Document&pageSize=2&currentPageIndex=1
    ```
    Related topics:
    *   [Query Endpoint]({{page page='query-endpoint'}})
    *   [Using the REST API with the JavaScript Client](https://github.com/nuxeo/nuxeo-js-client/blob/release-6.0/test/document.js)

2.  **Command Operations**

    Client side

    A set of Automation operations allow to query a page provider that has been declared on the server. Scope is pretty much the same as with the query endpoint, you may prefer using Automation if you are in a Java environment as the Automation Java client is best suited for this use case.

    Example: TODO sample cURL POST

    Related topics:
    *   [PageProvider Operation definition](http://explorer.nuxeo.org/nuxeo/site/distribution/Nuxeo%20Platform-6.0/viewOperation/Document.PageProvider)
    *   [How to Use the Java Automation Client]({{page page='java-automation-client'}})
    *   [How to use the PageProvider operation with the from the JavaScript client](https://github.com/nuxeo/nuxeo-js-client/blob/release-6.0/test/automation.js) (search for "Document.PageProvider")

3.  **CMIS**

    Client side & Server side

    The Nuxeo Platform is compatible with the CMIS standard. CMIS covers query scope, using CMISQL. It is possible to query the Nuxeo Platform repository using CMISQL in Java server side, or via SOAP and ATOM/PUB bindings remotely.

    Example:
    ```
    ItemIterable<QueryResult> results =Â 
    session.query(
    "SELECTÂ 
    * FROMÂ 
    cmis:document"
    , false);
    for
    (QueryResult hit: results) {
    for(PropertyData<?> property: hit.getProperties())Â 
    {  String queryName = property.getQueryName();
            Object value = property.getFirstValue();
    }
    ```
    Related topics:
    *   [Nuxeo CMIS Implementation]({{page page='cmis'}})
    *   [How to Make CMISQL Queries Using Java]({{page page='how-to-make-cmisql-queries-using-java'}})
    *   [Apache OpenCMIS website](http://chemistry.apache.org/)
    *   [Processing a Query With CMIS](http://chemistry.apache.org/java/examples/example-process-query-results.html) in Java

4.  **PageProvider**

    Server side

    Page Providers objects implement the PageProvider interface. It provides in Java all the primitives for getting each documents, pages and related information.

    Example:
    ```
    PageProvider<DocumentModel> pp = (PageProvider<DocumentModel>) ppService.getPageProvider(
            "TREE_CHILDREN_PP", null, null, null, props,
            new Object[] { myDoc.getId() });
    List<DocumentModel> documents = pp.getCurrentPage();
    ```
    Related topics:
    *   [Page Provider documentation page]({{page page='page-providers'}})

5.  **CoreSession.query**

    Server side

    The CoreSession object is the main server side Java interface for accession among the repository. Among available methods is the `query()` that allows to perform directly an NXQL query and get a list of documentModels (the basic Java wrapping of a Nuxeo Document). In most of the situations it is better to rely on a page provider as it is easier to override, maintain, etc&hellip; but `session.query()` is still an option.

6.  **CoreSession.QueryAndFetch()**

    Server side
    TODO

## {{> anchor 'elasticsearchconfiguration'}}Elasticsearch Configuration

The default configuration uses an embedded Elasticsearch instance that runs in the same JVM as the Nuxeo Platform's one. By default the Elasticsearch indexes will be located in `nxserver/data/elasticsearch`.

{{#> callout type='warning' }}

This embedded mode **is only for testing purpose** and should not be used in production.

{{/callout}}

See the [administration documentation to setup and configure an Elasticsearch](/x/UBY5AQ) cluster.

## Full-Text Capabilities

Both VCS/DBS implementations and Elasticsearch provide full-text search capabilities. Depending on the back end (Oracle, Postgres, SQL server, &hellip;) capabilities may be slightly different. The Elasticsearch implementation performs bests in terms of relevancy, for configuring dictionaries, running the stemming etc. Thus it is advised to leverage an Elasticsearch page provider when you want to do searches on full text index.

More documentation can be found about[ full-text search expressions]({{page page='full-text-queries'}}).

You should also read carefully how you can [tune the full-text index ]({{page page='configuring-the-elasticsearch-mapping'}})for maximizing the relevance depending on your context of use.

## Facets and Other Aggregates Support

Aggregates are a way to compute additional information on a search result so as to group and count result items and project them against various axis. For instance, "in the search result, 5 of the documents have the value "Specifications" for the field [`dc:nature`](http://dcnature) ". The Elasticsearch page provider implementation provides aggregates support. It is possible to define which aggregates can be requested to Elasticsearch with each queries, and a mechanism is implemented so as to filter following queries with the aggregates system offered by Elasticsearch. It is possible to leverage aggregates both at the API level and in the user interface, where a set of dedicated aggregates widgets has been added. They can be used from Nuxeo Studio.

See the [How-to about aggregates widgets]({{page page='how-to-configure-a-search-filter-with-facets-and-other-aggregates'}}).

![Terms with Directory Widget]({{file name='Screen Shot 2014-11-02 at 19.13.27.png'}} ?w=100,h=54,border=true 'Terms with Directory Widget') ![Date Histograms and Date Ranges]({{file name='Screen Shot 2014-11-02 at 21.02.45.png'}} ?w=100,h=71,border=true 'Date Histograms and Date Ranges') ![]({{file name='Screen Shot 2014-11-02 at 21.02.54.png'}} ?w=100,border=true,thumbnail=true 'Terms with User & Groups Widget') ![Range]({{file name='Screen Shot 2014-11-02 at 21.03.01.png'}} ?w=100,h=41,border=true 'Range')

## Configuring Search Interfaces in the Nuxeo Platform Back Office: Content Views

Search UI has been conceptualized throughout the notion of &ldquo;content view&rdquo; in the Nuxeo Platform framework. The [Content View]({{page space='glos' page='content-view'}}) object holds all the necessary information for rendering a search filter, the associated page provider, a search result and all actions that can be made around that search result (sorting, exporting, slide showing, selection actions&hellip;). Content views are [fully configurable via Nuxeo Studio]({{page page='how-to-define-a-new-content-view'}}) which makes it a matter of a few minutes to configure new business specific search screens for your application users.

![A Content View]({{file name='Screen Shot 2014-11-02 at 21.07.25.png'}} ?w=600,border=true 'A Content View')

## Indexing Logic

The section [Elasticsearch Indexing Logic]({{page page='elasticsearch-indexing-logic'}}) provides more details on how documents are indexed in Elasticsearch.

**In this section:**

*   [NXQL]({{page space='NXDOC60' page='NXQL'}})
*   [Full-Text Queries]({{page space='NXDOC60' page='Full-Text Queries'}})&nbsp;&mdash; Nuxeo documents can be searched using full-text queries; the standard way to do so is to use the top-right "quick search" box in the Nuxeo Platform. Search queries are expressed in a Nuxeo-defined syntax, described below.
*   [Page Providers]({{page space='NXDOC60' page='Page Providers'}})&nbsp;&mdash; Page providers allow retrieving items with pagination facilities, they can be used in a non-UI or non-JSF context like event listeners or core services.
*   [Page Provider Aggregates]({{page space='NXDOC60' page='Page Provider+Aggregates'}})&nbsp;&mdash; When using the Elasticsearch Page Provider, you can define aggregates that will be returned along with the query result.
*   [Configuring the Elasticsearch Mapping]({{page space='NXDOC60' page='Configuring the+Elasticsearch+Mapping'}})&nbsp;&mdash; This documentation page talks about the many aspects you can tune for improving the search experience for your users when it comes to full-text search. This page is limited to full-text searches querying the Elasticsearch index, which is the recommended index for performing full-text searches.
*   [Elasticsearch Indexing Logic]({{page space='NXDOC60' page='Elasticsearch Indexing+Logic'}})
*   [How to Configure a New Default Search Form in the Search Tab]({{page space='NXDOC60' page='How to+Configure+a+New+Default+Search+Form+in+the+Search+Tab'}})
*   [How to Make CMISQL Queries Using Java]({{page space='NXDOC60' page='How to+Make+CMISQL+Queries+Using+Java'}})
*   [How to Make a Page Provider or Content View Query Elasticsearch Index]({{page space='NXDOC60' page='How to+Make+a+Page+Provider+or+Content+View+Query+Elasticsearch+Index'}})&nbsp;&mdash; Learn how to make a content view query Elasticsearch instead of the Core API.
*   [How to Configure a Search Filter With Facets and Other Aggregates]({{page space='NXDOC60' page='How to+Configure+a+Search+Filter+With+Facets+and+Other+Aggregates'}})
*   [Indexing and Querying How-To Index]({{page space='NXDOC60' page='Indexing and+Querying+How-To+Index'}})
*   [Quick Search]({{page space='NXDOC60' page='Quick Search'}})&nbsp;&mdash; The simple search is configured to work in conjunction with a content view. This section describes the document type and layouts used in the default simple search.
*   [Moving Load from Database to Elasticsearch]({{page space='NXDOC60' page='Moving Load+from+Database+to+Elasticsearch'}})&nbsp;&mdash; By moving query load from the database to Elasticsearch,&nbsp;applications can dramatically increase performance and scalability.
